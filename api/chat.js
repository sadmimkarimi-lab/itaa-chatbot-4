// api/chat.js
import { Redis } from "@upstash/redis";

// âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­Ø¯ÙˆØ¯ÛŒØª
const WINDOW_SECONDS = 6 * 60 * 60;
const MAX_MESSAGES = 10;

let redis = null;
if (process.env.UPSTASH_REDIS_REST_URL && process.env.UPSTASH_REDIS_REST_TOKEN) {
  redis = new Redis({
    url: process.env.UPSTASH_REDIS_REST_URL,
    token: process.env.UPSTASH_REDIS_REST_TOKEN,
  });
}

async function checkRateLimit(ip) {
  if (!redis) return { allowed: true };

  const key = `rate:${ip}`;
  let count = await redis.get(key);

  if (count === null) {
    await redis.set(key, 1, { ex: WINDOW_SECONDS });
    return { allowed: true, remaining: MAX_MESSAGES - 1 };
  }

  count = Number(count);

  if (count >= MAX_MESSAGES) {
    return { allowed: false, remaining: 0 };
  }

  await redis.set(key, count + 1, { ex: WINDOW_SECONDS });
  return { allowed: true, remaining: MAX_MESSAGES - (count + 1) };
}

// â­â­â­ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø®Ø±ÙˆØ¬ÛŒ â€” Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ù„Ù…Ø§Øª Ø¹Ø¬ÛŒØ¨ â­â­â­
function cleanText(text) {
  return text
    // Ø­Ø°Ù Ø­Ø±ÙˆÙ ØºÛŒØ± ÙØ§Ø±Ø³ÛŒ + Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú†ÛŒÙ†ÛŒ/Ø±ÙˆØ³ÛŒ/Ø§Ø±ÙˆÙ¾Ø§ÛŒÛŒ
    .replace(/[^\u0600-\u06FF\s0-9.,!?ØŸ!]/g, "")
    // Ù…Ø±ØªØ¨ Ú©Ø±Ø¯Ù† ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§
    .replace(/\s+/g, " ")
    .trim();
}

// ğŸš« Ù„ÛŒØ³Øª Ú©Ù„Ù…Ø§Øª Ùˆ Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ù…Ù…Ù†ÙˆØ¹ (Ø³Ø®Øªâ€ŒÚ¯ÛŒØ±Ø§Ù†Ù‡)
const BLOCKED_KEYWORDS = [
  // Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø¬Ù†Ø³ÛŒØŒ Ø²Ù†Ø§Ø´ÙˆÛŒÛŒ Ùˆ ØºÛŒØ±Ø§Ø®Ù„Ø§Ù‚ÛŒ
  "Ø³Ú©Ø³",
  "Ø±Ø§Ø¨Ø·Ù‡ Ø¬Ù†Ø³ÛŒ",
  "Ø±Ø§Ø¨Ø·Ù‡ Ù†Ø§Ù…Ø´Ø±ÙˆØ¹",
  "Ù¾ÙˆØ±Ù†",
  "Ù¾ÙˆØ±Ù†Ùˆ",
  "ÙÛŒÙ„Ù… Ù…Ø³ØªÙ‡Ø¬Ù†",
  "Ù…Ø³ØªÙ‡Ø¬Ù†",
  "Ø¨Ø±Ù‡Ù†Ù‡",
  "Ù†ÛŒÙ…Ù‡ Ø¨Ø±Ù‡Ù†Ù‡",
  "Ù‡Ù…Ø®ÙˆØ§Ø¨ÛŒ",
  "Ù‡Ù… Ø®ÙˆØ§Ø¨",
  "Ø²Ù†Ø§Ø´ÙˆÛŒÛŒ",
  "ØªØ­Ø±ÛŒÚ© Ø¬Ù†Ø³ÛŒ",
  "ÙØ§Ù†ØªØ²ÛŒ Ø¬Ù†Ø³ÛŒ",
  "Ø³Ú©Ø³ÛŒ",
  "Ø§Ø±Ø¶Ø§Ø¡",
  "Ø§Ø±Ø¶Ø§",
  "Ø®ÙˆØ¯Ø§Ø±Ø¶Ø§ÛŒÛŒ",
  "Ø®ÙˆØ¯ Ø§Ø±Ø¶Ø§ÛŒÛŒ",
  "Ø±Ø§Ø¨Ø·Ù‡ Ù†Ø§Ù…ØªØ¹Ø§Ø±Ù",
  "Ù‡Ù…Ø¬Ù†Ø³Ú¯Ø±Ø§",
  "Ù‡Ù…â€ŒØ¬Ù†Ø³â€ŒÚ¯Ø±Ø§",
  "Ù„Ø²Ø¨ÛŒÙ†",
  "Ú¯ÛŒ",
  "Ú¯ÙÛŒ",

  // ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ø§Ø¯ÛŒØ§Ù†ØŒ Ù…Ø°Ø§Ù‡Ø¨ Ùˆ Ù…Ù‚Ø¯Ø³Ø§Øª
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ø¯ÛŒÙ†",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ø§Ø³Ù„Ø§Ù…",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ø´ÛŒØ¹Ù‡",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ ØªØ´ÛŒØ¹",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ù…Ø³Ù„Ù…Ø§Ù†",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ù‚Ø±Ø¢Ù†",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ù¾ÛŒØ§Ù…Ø¨Ø±",
  "Ø¨ÛŒâ€ŒØ¯ÛŒÙ†ÛŒ",
  "Ú©ÙØ± Ú¯ÙØªÙ†",
  "Ø§Ù‡Ø§Ù†Øª Ø¨Ù‡ Ù…Ù‚Ø¯Ø³Ø§Øª",

  // Ø®Ø´ÙˆÙ†Øª Ø´Ø¯ÛŒØ¯ØŒ Ø¬Ø±Ù… Ùˆ Ø±ÙØªØ§Ø±Ù‡Ø§ÛŒ Ø®Ø·Ø±Ù†Ø§Ú©
  "Ø¢Ù…ÙˆØ²Ø´ Ø®ÙˆØ¯Ú©Ø´ÛŒ",
  "Ù†Ø­ÙˆÙ‡ Ø®ÙˆØ¯Ú©Ø´ÛŒ",
  "Ø®ÙˆØ¯Ú©Ø´ÛŒ",
  "Ø¢Ø³ÛŒØ¨ Ø²Ø¯Ù† Ø¨Ù‡ Ø®ÙˆØ¯",
  "Ø¢Ø³ÛŒØ¨ Ø¨Ù‡ Ø¯ÛŒÚ¯Ø±Ø§Ù†",
  "Ù‚ØªÙ„",
  "Ú†Ø·ÙˆØ± Ú©Ø³ÛŒ Ø±Ø§ Ø¨Ú©Ø´Ù…",
  "Ø³Ø§Ø®Øª Ù…ÙˆØ§Ø¯ Ù…Ø®Ø¯Ø±",
  "Ù¾Ø®Øª Ù…ÙˆØ§Ø¯ Ù…Ø®Ø¯Ø±",
  "Ø®Ø±ÛŒØ¯ Ù…ÙˆØ§Ø¯ Ù…Ø®Ø¯Ø±",
  "ÙØ±Ø§Ø± Ø§Ø² Ù‚Ø§Ù†ÙˆÙ†",
  "Ø¯ÙˆØ± Ø²Ø¯Ù† Ù‚Ø§Ù†ÙˆÙ†",
  "Ø¢Ø²Ø§Ø± Ú©ÙˆØ¯Ú©",
  "Ø³ÙˆØ¡Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¬Ù†Ø³ÛŒ",
  "Ø³ÙˆØ¡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¬Ù†Ø³ÛŒ"
];

// ğŸ§  Ù…Ø¯Ù„â€ŒÙ‡Ø§
const GROQ_MODELS = [
  "llama-3.3-70b-versatile",
  "llama-3.1-8b-instant",
  "gpt-oss-20b",
];

const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";
const GROQ_API_KEY = process.env.GROQ_API_KEY;

async function askGroq(userMessage) {
  if (!GROQ_API_KEY) {
    return "Ú©Ù„ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.";
  }

  const systemPrompt = `
ØªÙˆ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ÙØ§Ø±Ø³ÛŒâ€ŒØ²Ø¨Ø§Ù†ØŒ Ù…Ù‡Ø±Ø¨Ø§Ù†ØŒ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ø¹Ù…Ù„â€ŒÚ¯Ø±Ø§ Ù‡Ø³ØªÛŒ.

Ù‚ÙˆØ§Ù†ÛŒÙ† Ú©Ù„ÛŒ Ú¯ÙØªÚ¯Ùˆ:
1) ÙÙ‚Ø· Ùˆ ÙÙ‚Ø· Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø±ÙˆØ§Ù† Ø¬ÙˆØ§Ø¨ Ø¨Ø¯Ù‡.
2) Ø§Ø² Ù†ÙˆØ´ØªÙ† Ú©Ù„Ù…Ø§Øª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ ÙÛŒÙ†Ú¯Ù„ÛŒØ´ ÛŒØ§ Ú©Ù„Ù…Ø§Øª Ø¹Ø¬ÛŒØ¨ (Ù…Ø«Ù„ procesoØŒ aboutØŒ zpÅ¯sobØŒ ngèµ° Ùˆ...) Ú©Ø§Ù…Ù„Ø§Ù‹ Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†.
3) Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ú©Ù„Ù…Ù‡Ù” Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ù†ÙˆØ´Øª (Ù…Ø«Ù„ InstagramØŒ CanvaØŒ AI)ØŒ
   ØªÙˆ ÙÙ‚Ø· Ù‡Ù…Ø§Ù† Ú©Ù„Ù…Ù‡ Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ø§Ù† Ø´Ú©Ù„ ØªÚ©Ø±Ø§Ø± Ú©Ù† Ùˆ Ø¨Ù‚ÛŒÙ‡Ù” Ø¬Ù…Ù„Ù‡ Ø±Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ ÙØ§Ø±Ø³ÛŒ Ø¨Ù†ÙˆÛŒØ³.
4) Ø§Ú¯Ø± Ø¯Ø± Ù…ÛŒØ§Ù†Ù‡Ù” ØªÙˆÙ„ÛŒØ¯ Ù…ØªÙ† Ø§Ø­Ø³Ø§Ø³ Ú©Ø±Ø¯ÛŒ Ú©Ù„Ù…Ù‡Ù” ØºÛŒØ± ÙØ§Ø±Ø³ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù† Ø§Ø³ØªØŒ
   Ø¢Ù† Ø±Ø§ Ø­Ø°Ù Ú©Ù† Ùˆ Ø¨Ù‡ Ø¬Ø§ÛŒØ´ Ù…Ø¹Ø§Ø¯Ù„ ÙØ§Ø±Ø³ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ù†ÙˆÛŒØ³.
5) Ø¬Ù…Ù„Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ú©ÙˆØªØ§Ù‡ØŒ ÙˆØ§Ø¶Ø­ Ùˆ Ø¨Ø¯ÙˆÙ† Ø­Ø§Ø´ÛŒÙ‡ Ø¨Ø§Ø´Ù†Ø¯. Ù¾Ø±Ú†Ø§Ù†Ú¯ÛŒ Ù†Ú©Ù†.
6) Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ù‡ÙˆÛŒØªØ´ (Ø§ÛŒÙ†â€ŒÚ©Ù‡ Ú©ÛŒ Ù‡Ø³ØªÛŒØŒ Ø´ØºÙ„Øª Ú†ÛŒÙ‡ Ùˆ...) Ø³Ø¤Ø§Ù„ Ù†Ù¾Ø±Ø³Ø›
   Ù…Ø³ØªÙ‚ÛŒÙ… Ø³Ø±Ø§Øº Ø¬ÙˆØ§Ø¨ Ø¨Ø±Ùˆ.
7) ÙÙ‚Ø· Ø§Ú¯Ø± Ø³Ø¤Ø§Ù„ Ú©Ø§Ø±Ø¨Ø± Ø®ÛŒÙ„ÛŒ Ù…Ø¨Ù‡Ù… Ø¨ÙˆØ¯ØŒ Ø­Ø¯Ø§Ú©Ø«Ø± ÛŒÚ© Ø³Ø¤Ø§Ù„ Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø´ÙØ§Ùâ€ŒØ³Ø§Ø²ÛŒ Ø¨Ù¾Ø±Ø³Ø›
   Ø¯Ø± Ø¨Ù‚ÛŒÙ‡Ù” Ù…ÙˆØ§Ø±Ø¯ Ø®ÙˆØ¯Øª ÛŒÚ© ÙØ±Ø¶ Ù…Ù†Ø·Ù‚ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ùˆ Ø¬ÙˆØ§Ø¨ Ø¨Ø¯Ù‡.
8) Ù„Ø­Ù†: Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ØŒ ØµÙ…ÛŒÙ…ÛŒ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒØ› Ù…Ø«Ù„ ÛŒÚ© Ø¯ÙˆØ³Øª Ø¨Ø§ØªØ¬Ø±Ø¨Ù‡ØŒ Ù†Ù‡ Ù…Ø«Ù„ Ù…ØªÙ† Ø§Ø¯Ø§Ø±ÛŒ Ø®Ø´Ú©.
9) Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø®ÙˆØ§Ø³Øª Â«Ú†Ù†Ø¯ Ù¾Ø³ØªÂ» ÛŒØ§ Â«Ú†Ù†Ø¯ Ø§ÛŒØ¯Ù‡Â» Ø¨Ù†ÙˆÛŒØ³ÛŒ:
   - Ø¯Ù‚ÛŒÙ‚Ø§ Ù‡Ù…Ø§Ù† ØªØ¹Ø¯Ø§Ø¯ Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ú©Ù† (Ù…Ø«Ù„Ø§Ù‹ Ûµ Ù¾Ø³Øª)
   - Ù‡Ø± Ù¾Ø³Øª Ø±Ø§ Ø¨Ø§ Â«Ù¾Ø³Øª Û±:Â»ØŒ Â«Ù¾Ø³Øª Û²:Â» Ùˆ ... Ø¬Ø¯Ø§ Ú©Ù†
   - Ù‡Ø± Ù¾Ø³Øª Ø´Ø§Ù…Ù„ Û² ØªØ§ Û´ Ø¬Ù…Ù„Ù‡Ù” Ú©ÙˆØªØ§Ù‡ Ø¨Ø§Ø´Ø¯ (Ø¨Ø¯ÙˆÙ† Ù…ØªÙ† Ø·ÙˆÙ„Ø§Ù†ÛŒ Ø®Ø³ØªÙ‡â€ŒÚ©Ù†Ù†Ø¯Ù‡).
10) Ø§Ø² Ø§ÛŒÙ…ÙˆØ¬ÛŒ ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ØŒ Ø¢Ù† Ù‡Ù… Ø­Ø¯Ø§Ú©Ø«Ø± Ø¯Ùˆ Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø¯Ø± Ú©Ù„ Ù¾Ø§Ø³Ø®.

Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø®Ù„Ø§Ù‚ÛŒØŒ Ø¯ÛŒÙ†ÛŒ Ùˆ Ø§Ù†Ø³Ø§Ù†ÛŒ (Ø®ÛŒÙ„ÛŒ Ù…Ù‡Ù…):
11) Ø§Ø² Ù†ÙˆØ´ØªÙ† Ù‡Ø±Ú¯ÙˆÙ†Ù‡ Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ø®Ø§Ù„Ù Ø§Ø±Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø³Ù„Ø§Ù…ÛŒØŒ Ù…Ø°Ù‡Ø¨ ØªØ´ÛŒØ¹ Ùˆ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¬Ù…Ù‡ÙˆØ±ÛŒ Ø§Ø³Ù„Ø§Ù…ÛŒ Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†.
12) Ù‡ÛŒÚ†â€ŒÚ¯ÙˆÙ†Ù‡ ØªÙˆÙ‡ÛŒÙ†ØŒ Ø¨ÛŒâ€ŒØ§Ø­ØªØ±Ø§Ù…ÛŒØŒ ØªÙ…Ø³Ø®Ø± ÛŒØ§ Ø§Ø¸Ù‡Ø§Ø± Ù†Ø¸Ø± Ù…Ù†ÙÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù”
    Ø§Ø¯ÛŒØ§Ù†ØŒ Ù…Ø°Ø§Ù‡Ø¨ØŒ Ø§Ù‚ÙˆØ§Ù…ØŒ Ù…Ù„ÛŒØªâ€ŒÙ‡Ø§ØŒ Ø¢ÛŒÛŒÙ†â€ŒÙ‡Ø§ Ùˆ Ø¨Ø§ÙˆØ±Ù‡Ø§ÛŒ Ù…Ø¹Ù†ÙˆÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø¯Ù‡.
13) Ø¯Ø± Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø²Ù†Ø§Ø´ÙˆÛŒÛŒØŒ Ø¬Ù†Ø³ÛŒØŒ Ø±ÙˆØ§Ø¨Ø· Ù†Ø§Ù…ØªØ¹Ø§Ø±ÙØŒ Ø§Ù„ÙØ§Ø¸ Ø±Ú©ÛŒÚ© ÛŒØ§
    Ù…Ø­ØªÙˆØ§Ù‡Ø§ÛŒ ØªØ­Ø±ÛŒÚ©â€ŒØ¢Ù…ÛŒØ²:
    - ØªÙˆØ¶ÛŒØ­ Ù†Ø¯Ù‡
    - Ø±Ø§Ù‡Ú©Ø§Ø± Ù†Ø¯Ù‡
    - ÙˆØ§Ø±Ø¯ Ø¬Ø²Ø¦ÛŒØ§Øª Ù†Ø´Ùˆ
    - ÙÙ‚Ø· Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ Ø¨Ú¯Ùˆ: Â«Ø¯Ø± Ø§ÛŒÙ† Ø²Ù…ÛŒÙ†Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… ØµØ­Ø¨Øª Ú©Ù†Ù….Â»
14) Ø§Ø² ØªØ´ÙˆÛŒÙ‚ØŒ Ø¢Ù…ÙˆØ²Ø´ ÛŒØ§ ØªÙˆØ¬ÛŒÙ‡ Ù‡Ø±Ú¯ÙˆÙ†Ù‡ Ø±ÙØªØ§Ø± Ø®Ù„Ø§Ù Ø§Ø®Ù„Ø§Ù‚ØŒ Ø®Ø´ÙˆÙ†Øªâ€ŒØ¢Ù…ÛŒØ²ØŒ
    Ù…Ø¬Ø±Ù…Ø§Ù†Ù‡ØŒ Ø®Ù„Ø§Ù Ù‚Ø§Ù†ÙˆÙ†ØŒ Ø®ÙˆØ¯Ø¢Ø²Ø§Ø±ÛŒØŒ Ù…ØµØ±Ù Ù…ÙˆØ§Ø¯ØŒ ÙØ±ÛŒØ¨ØŒ ØªÙ‡Ø¯ÛŒØ¯ ÛŒØ§ Ù‚Ø§Ù†ÙˆÙ†â€ŒÚ¯Ø±ÛŒØ²ÛŒ Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†.
15) Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ù†Ø§Ù…Ù†Ø§Ø³Ø¨ ÛŒØ§ ØºÛŒØ±Ø§Ø®Ù„Ø§Ù‚ÛŒ Ù…Ø·Ø±Ø­ Ú©Ø±Ø¯:
    - Ù¾Ø§Ø³Ø® Ú©ÙˆØªØ§Ù‡ØŒ Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ Ùˆ Ù‚Ø§Ø·Ø¹ Ø¨Ø¯Ù‡ Ú©Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ú©Ù…Ú© Ú©Ù†ÛŒ
    - Ø¯Ø± ØµÙˆØ±Øª Ø§Ù…Ú©Ø§Ù†ØŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡ Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø³Ø§Ù„Ù…ØŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ùˆ Ø³Ø§Ø²Ù†Ø¯Ù‡ ØµØ­Ø¨Øª Ø´ÙˆØ¯.
16) Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ø³Ù„Ø§Ù…Øª Ø¬Ø³Ù…ÛŒ Ùˆ Ø±ÙˆØ§Ù†ÛŒØŒ Ø¯Ø§Ø±ÙˆØŒ Ø¯Ø±Ù…Ø§Ù†ØŒ ÛŒØ§ ØªØ´Ø®ÛŒØµ Ø¨ÛŒÙ…Ø§Ø±ÛŒ:
    - ÙÙ‚Ø· Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ Ùˆ Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ø¯Ù‡
    - Ø­ØªÙ…Ø§Ù‹ ØªØ£Ú©ÛŒØ¯ Ú©Ù† Ú©Ù‡ ØªØµÙ…ÛŒÙ… Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ù…Ø´ÙˆØ±Øª Ù¾Ø²Ø´Ú© ÛŒØ§ Ù…ØªØ®ØµØµ Ø¨Ø§Ø´Ø¯.
17) ÙˆØ§Ø±Ø¯ ØªØ­Ù„ÛŒÙ„â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ§Ø³ÛŒ Ø­Ø³Ø§Ø³ØŒ ØªØ­Ø±ÛŒÚ©â€ŒØ¢Ù…ÛŒØ²ØŒ Ø¬Ø§Ù†Ø¨Ø¯Ø§Ø±Ø§Ù†Ù‡ ÛŒØ§ Ù…Ø±ØªØ¨Ø· Ø¨Ø§ Ø§Ø®ØªÙ„Ø§ÙØ§Øª ØªÙ†Ø¯ Ø³ÛŒØ§Ø³ÛŒ Ù†Ø´Ùˆ.
18) Ø§Ø² ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø­Ø§ÙˆÛŒ Ù†ÙØ±ØªØŒ ØªØ¨Ø¹ÛŒØ¶ØŒ Ù†Ú˜Ø§Ø¯Ù¾Ø±Ø³ØªÛŒ ÛŒØ§ ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ù‡Ø± Ù‚ÙˆÙ… Ùˆ Ù…Ù„Øª Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†.
19) Ù‡ÛŒÚ†â€ŒÙˆÙ‚Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ Ù…Ø§Ù†Ù†Ø¯ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ØŒ Ø¢Ø¯Ø±Ø³ØŒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù†Ú©ÛŒ Ùˆ Ù…ÙˆØ§Ø±Ø¯ Ù…Ø´Ø§Ø¨Ù‡ Ø±Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ú©Ù†ØŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ú©Ù† Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ú©Ù†.
20) Ù„Ø­Ù† ØªÙˆ Ù‡Ù…ÛŒØ´Ù‡ Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ØŒ Ù…Ø¤Ø¯Ø¨ØŒ Ø¢Ø±Ø§Ù…ØŒ Ø³Ø§Ø²Ù†Ø¯Ù‡ Ùˆ Ø§Ù†Ø³Ø§Ù†â€ŒØ¯ÙˆØ³ØªØ§Ù†Ù‡ Ø¨Ø§Ø´Ø¯.
`;

  for (const model of GROQ_MODELS) {
    try {
      const response = await fetch(GROQ_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${GROQ_API_KEY}`,
        },
        body: JSON.stringify({
          model,
          messages: [
            { role: "system", content: systemPrompt },
            { role: "user", content: userMessage },
          ],
        }),
      });

      if (!response.ok) {
        console.error(`Groq model error (${model}) â†’`, await response.text());
        continue;
      }

      const data = await response.json();
      let answer =
        data?.choices?.[0]?.message?.content?.trim() ||
        "Ù†ØªÙˆØ§Ù†Ø³ØªÙ… Ù¾Ø§Ø³Ø® Ù…Ù†Ø§Ø³Ø¨ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù….";

      // ğŸ”¥ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø®Ø±ÙˆØ¬ÛŒ
      const finalText = cleanText(answer);
      return finalText;

    } catch (err) {
      console.error(`Groq failed (${model})`, err);
      continue;
    }
  }

  return "Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø³Ø±ÙˆÛŒØ³ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. Ú©Ù…ÛŒ Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.";
}

export default async function handler(req, res) {
  if (req.method !== "POST") return res.status(200).send("OK");

  const body = req.body || {};
  const userMessage =
    body.text ||
    body.message ||
    body?.message?.text ||
    "";

  if (!userMessage || typeof userMessage !== "string") {
    return res.status(400).json({
      ok: false,
      answer: "Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.",
    });
  }

  // ğŸš« ÙÛŒÙ„ØªØ± Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ù…Ù†ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ø² Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø¯Ù„
  const lowered = userMessage.toString().toLowerCase();
  const hasBlocked = BLOCKED_KEYWORDS.some((w) => lowered.includes(w));

  if (hasBlocked) {
    return res.status(200).json({
      ok: true,
      answer:
        "Ø¯Ø± Ø§ÛŒÙ† Ø²Ù…ÛŒÙ†Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… ØµØ­Ø¨Øª Ú©Ù†Ù…. Ø§Ú¯Ø± Ø³ÙˆØ§Ù„ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¯Ø± Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù…ØŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ùˆ Ù…ÙÛŒØ¯ Ø¯Ø§Ø±ÛŒ Ø¨Ø§ Ø®ÙˆØ´Ø­Ø§Ù„ÛŒ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù….",
    });
  }

  // IP Ø¨Ø±Ø§ÛŒ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª
  const xff = req.headers["x-forwarded-for"];
  const ip =
    (Array.isArray(xff) ? xff[0] : xff?.split(",")[0]) ||
    req.socket?.remoteAddress ||
    "unknown";

  try {
    const limit = await checkRateLimit(ip);
    if (!limit.allowed) {
      return res.status(200).json({
        ok: true,
        answer:
          "Ø¯Ø± Ù‡Ø± Û¶ Ø³Ø§Ø¹Øª ÙÙ‚Ø· Û±Û° Ù¾ÛŒØ§Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒ. Ù„Ø·ÙØ§Ù‹ Ú©Ù…ÛŒ Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†.",
      });
    }
  } catch (e) {}

  const answer = await askGroq(userMessage);

  return res.status(200).json({
    ok: true,
    answer,
  });
}
