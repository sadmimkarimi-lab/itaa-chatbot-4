// api/chat.js
import { Redis } from "@upstash/redis";

// âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù¾ÛŒØ§Ù…
const WINDOW_SECONDS = 6 * 60 * 60; // Û¶ Ø³Ø§Ø¹Øª
const MAX_MESSAGES = 10;            // Ø­Ø¯Ø§Ú©Ø«Ø± Û±Û° Ù¾ÛŒØ§Ù… Ø¯Ø± Ù‡Ø± Û¶ Ø³Ø§Ø¹Øª Ø¨Ø±Ø§ÛŒ Ù‡Ø± IP

// âš™ï¸ Ø³Ù‚Ù Ù…ØµØ±Ù Ø±ÙˆØ²Ø§Ù†Ù‡â€ŒÛŒ ØªÙˆÚ©Ù† Ø¨Ø±Ø§ÛŒ Ú©Ù„ Ø±Ø¨Ø§Øª
// Ù‡Ø± ÙˆÙ‚Øª Ø¯ÛŒØ¯ÛŒ Ù‡Ù†ÙˆØ² Ø²ÛŒØ§Ø¯ Ù…ØµØ±Ù Ù…ÛŒâ€ŒØ´ÙˆØ¯ØŒ Ø§ÛŒÙ† Ø¹Ø¯Ø¯ Ø±Ø§ Ú©Ù…ØªØ± ÛŒØ§ Ø¨ÛŒØ´ØªØ± Ú©Ù†
const DAILY_TOKEN_LIMIT = 450000;

let redis = null;
if (process.env.UPSTASH_REDIS_REST_URL && process.env.UPSTASH_REDIS_REST_TOKEN) {
  redis = new Redis({
    url: process.env.UPSTASH_REDIS_REST_URL,
    token: process.env.UPSTASH_REDIS_REST_TOKEN,
  });
}

// âœ… Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù… Ø¨Ø± Ø§Ø³Ø§Ø³ IP (Ù‡Ù…Ø§Ù† Ù…Ù†Ø·Ù‚ Ù†Ø³Ø®Ù‡ Û²Û°)
async function checkRateLimit(ip) {
  if (!redis) return { allowed: true };

  const key = `rate:${ip}`;
  let count = await redis.get(key);

  if (count === null) {
    await redis.set(key, 1, { ex: WINDOW_SECONDS });
    return { allowed: true, remaining: MAX_MESSAGES - 1 };
  }

  count = Number(count);

  if (count >= MAX_MESSAGES) {
    return { allowed: false, remaining: 0 };
  }

  await redis.set(key, count + 1, { ex: WINDOW_SECONDS });
  return { allowed: true, remaining: MAX_MESSAGES - (count + 1) };
}

// âœ… Ú©Ù„ÛŒØ¯ Ù…Ø®ØµÙˆØµ Ø§Ù…Ø±ÙˆØ² Ø¨Ø±Ø§ÛŒ Ø«Ø¨Øª Ù…ØµØ±Ù ØªÙˆÚ©Ù†
function getTodayKey() {
  const today = new Date().toISOString().slice(0, 10); // YYYY-MM-DD
  return `tokens:${today}`;
}

// âœ… Ø§Ø¶Ø§ÙÙ‡â€ŒÚ©Ø±Ø¯Ù† ØªØ¹Ø¯Ø§Ø¯ ØªÙˆÚ©Ù† Ù…ØµØ±Ùâ€ŒØ´Ø¯Ù‡
async function addTokensUsed(tokens) {
  if (!redis || !tokens) return;
  const key = getTodayKey();
  await redis.incrby(key, tokens);
  await redis.expire(key, 60 * 60 * 27); // Ø­Ø¯ÙˆØ¯ Û²Û· Ø³Ø§Ø¹Øª
}

// âœ… Ú†Ú©â€ŒÚ©Ø±Ø¯Ù† Ø§ÛŒÙ†Ú©Ù‡ Ø³Ù‚Ù Ø±ÙˆØ²Ø§Ù†Ù‡ Ù¾Ø± Ø´Ø¯Ù‡ ÛŒØ§ Ù†Ù‡
async function isDailyLimitReached() {
  if (!redis) return false;
  const key = getTodayKey();
  const used = Number((await redis.get(key)) || 0);
  return used >= DAILY_TOKEN_LIMIT;
}

// â­â­â­ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ø®Ø±ÙˆØ¬ÛŒ â€” Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú©Ù„Ù…Ø§Øª Ø¹Ø¬ÛŒØ¨ â­â­â­
function cleanText(text) {
  return text
    // Ø­Ø°Ù Ø­Ø±ÙˆÙ ØºÛŒØ± ÙØ§Ø±Ø³ÛŒ + Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ú†ÛŒÙ†ÛŒ/Ø±ÙˆØ³ÛŒ/Ø§Ø±ÙˆÙ¾Ø§ÛŒÛŒ
    .replace(/[^\u0600-\u06FF\s0-9.,!?ØŸ!]/g, "")
    // Ù…Ø±ØªØ¨ Ú©Ø±Ø¯Ù† ÙØ§ØµÙ„Ù‡â€ŒÙ‡Ø§
    .replace(/\s+/g, " ")
    .trim();
}

// ğŸš« Ù„ÛŒØ³Øª Ú©Ù„Ù…Ø§Øª Ùˆ Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ù…Ù…Ù†ÙˆØ¹ (Ø¬Ù†Ø³ÛŒ/Ø®Ø´ÙˆÙ†Øª/ØªÙˆÙ‡ÛŒÙ†/Ø³ÛŒØ§Ø³ÛŒÙ ØªÙ†Ø¯)
const BLOCKED_KEYWORDS = [
  // Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø¬Ù†Ø³ÛŒØŒ Ø²Ù†Ø§Ø´ÙˆÛŒÛŒ Ùˆ ØºÛŒØ±Ø§Ø®Ù„Ø§Ù‚ÛŒ
  "Ø³Ú©Ø³",
  "sex",
  "Ø³Ú©Ø³ÛŒ",
  "Ø±Ø§Ø¨Ø·Ù‡ Ø¬Ù†Ø³ÛŒ",
  "Ø±Ø§Ø¨Ø·Ù‡ Ù†Ø§Ù…Ø´Ø±ÙˆØ¹",
  "Ù¾ÙˆØ±Ù†",
  "porn",
  "Ù¾ÙˆØ±Ù†Ùˆ",
  "ÙÛŒÙ„Ù… Ù…Ø³ØªÙ‡Ø¬Ù†",
  "Ù…Ø³ØªÙ‡Ø¬Ù†",
  "Ø¨Ø±Ù‡Ù†Ù‡",
  "Ø¨Ø±Ù‡Ù†Ú¯ÛŒ",
  "Ù†ÛŒÙ…Ù‡ Ø¨Ø±Ù‡Ù†Ù‡",
  "Ù‡Ù…Ø®ÙˆØ§Ø¨ÛŒ",
  "Ù‡Ù… Ø®ÙˆØ§Ø¨",
  "Ø²Ù†Ø§Ø´ÙˆÛŒÛŒ",
  "ØªØ­Ø±ÛŒÚ© Ø¬Ù†Ø³ÛŒ",
  "ÙØ§Ù†ØªØ²ÛŒ Ø¬Ù†Ø³ÛŒ",
  "Ø§Ø±Ø¶Ø§Ø¡",
  "Ø§Ø±Ø¶Ø§",
  "Ø®ÙˆØ¯Ø§Ø±Ø¶Ø§ÛŒÛŒ",
  "Ø®ÙˆØ¯ Ø§Ø±Ø¶Ø§ÛŒÛŒ",
  "Ø±Ø§Ø¨Ø·Ù‡ Ù†Ø§Ù…ØªØ¹Ø§Ø±Ù",
  "Ø´Ù‡ÙˆØª",
  "Ù„Ø¨ Ú¯Ø±ÙØªÙ†",
  "Ø¨ÙˆØ³Ù‡ Ø¬Ù†Ø³ÛŒ",
  "Ø­Ø±ÛŒÙ… Ø®ØµÙˆØµÛŒ Ø²Ù†Ø§Ø´ÙˆÛŒÛŒ",
  "Ù‡Ù…Ø¬Ù†Ø³Ú¯Ø±Ø§",
  "Ù‡Ù…â€ŒØ¬Ù†Ø³â€ŒÚ¯Ø±Ø§",
  "Ù„Ø²Ø¨ÛŒÙ†",
  "gay",
  "Ú¯ÛŒ",
  "ÙØ­Ø´Ø§",
  "ØªÙ† ÙØ±ÙˆØ´ÛŒ",
  "ØªÙ†â€ŒÙØ±ÙˆØ´ÛŒ",

  // ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ø§Ø¯ÛŒØ§Ù†ØŒ Ù…Ø°Ø§Ù‡Ø¨ Ùˆ Ù…Ù‚Ø¯Ø³Ø§Øª
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ø¯ÛŒÙ†",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ø§Ø³Ù„Ø§Ù…",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ø´ÛŒØ¹Ù‡",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ ØªØ´ÛŒØ¹",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ù…Ø³Ù„Ù…Ø§Ù†",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ù‚Ø±Ø¢Ù†",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ù¾ÛŒØ§Ù…Ø¨Ø±",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ø§Ù‡Ù„ Ø¨ÛŒØª",
  "Ø¨ÛŒâ€ŒØ¯ÛŒÙ†ÛŒ",
  "Ú©ÙØ± Ú¯ÙØªÙ†",
  "Ø§Ù‡Ø§Ù†Øª Ø¨Ù‡ Ù…Ù‚Ø¯Ø³Ø§Øª",
  "Ø§Ù‡Ø§Ù†Øª Ø¨Ù‡ Ø¯ÛŒÙ†",
  "Ø§Ù‡Ø§Ù†Øª Ø¨Ù‡ Ø®Ø¯Ø§",

  // Ø®Ø´ÙˆÙ†Øª Ø´Ø¯ÛŒØ¯ØŒ Ø¬Ø±Ù… Ùˆ Ø±ÙØªØ§Ø±Ù‡Ø§ÛŒ Ø®Ø·Ø±Ù†Ø§Ú©
  "Ø¢Ù…ÙˆØ²Ø´ Ø®ÙˆØ¯Ú©Ø´ÛŒ",
  "Ù†Ø­ÙˆÙ‡ Ø®ÙˆØ¯Ú©Ø´ÛŒ",
  "Ø®ÙˆØ¯Ú©Ø´ÛŒ",
  "Ú†Ø·ÙˆØ± Ø®ÙˆØ¯Ù… Ø±Ø§ Ø¨Ú©Ø´Ù…",
  "Ú†Ø·ÙˆØ± Ø®ÙˆØ¯Ù…Ùˆ Ø¨Ú©Ø´Ù…",
  "Ø¢Ø³ÛŒØ¨ Ø²Ø¯Ù† Ø¨Ù‡ Ø®ÙˆØ¯",
  "Ø¢Ø³ÛŒØ¨ Ø¨Ù‡ Ø¯ÛŒÚ¯Ø±Ø§Ù†",
  "Ù‚ØªÙ„",
  "Ú†Ø·ÙˆØ± Ú©Ø³ÛŒ Ø±Ø§ Ø¨Ú©Ø´Ù…",
  "Ø³Ø§Ø®Øª Ù…ÙˆØ§Ø¯ Ù…Ø®Ø¯Ø±",
  "Ù¾Ø®Øª Ù…ÙˆØ§Ø¯ Ù…Ø®Ø¯Ø±",
  "Ø®Ø±ÛŒØ¯ Ù…ÙˆØ§Ø¯ Ù…Ø®Ø¯Ø±",
  "ÙØ±ÙˆØ´ Ù…ÙˆØ§Ø¯ Ù…Ø®Ø¯Ø±",
  "Ù…ØµØ±Ù Ù…ÙˆØ§Ø¯ Ù…Ø®Ø¯Ø±",
  "ÙØ±Ø§Ø± Ø§Ø² Ù‚Ø§Ù†ÙˆÙ†",
  "Ø¯ÙˆØ± Ø²Ø¯Ù† Ù‚Ø§Ù†ÙˆÙ†",
  "Ø¢Ø²Ø§Ø± Ú©ÙˆØ¯Ú©",
  "Ú©ÙˆØ¯Ú©â€ŒØ¢Ø²Ø§Ø±ÛŒ",
  "Ú©ÙˆØ¯Ú© Ø¢Ø²Ø§Ø±ÛŒ",
  "Ø³ÙˆØ¡Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¬Ù†Ø³ÛŒ",
  "Ø³ÙˆØ¡ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø¬Ù†Ø³ÛŒ",
  "ØªØ¬Ø§ÙˆØ² Ø¬Ù†Ø³ÛŒ",
  "ØªÙ‡Ø¯ÛŒØ¯ Ø¬Ø§Ù†ÛŒ",
  "Ø³Ø§Ø®Øª Ø§Ø³Ù„Ø­Ù‡",
  "Ø³Ø§Ø®Øª Ø¨Ù…Ø¨",

  // Ù†ÙØ±Øª Ùˆ ØªÙˆÙ‡ÛŒÙ† Ø´Ø¯ÛŒØ¯ Ø¨Ù‡ Ø§Ù‚ÙˆØ§Ù… Ùˆ Ù…Ù„ÛŒØªâ€ŒÙ‡Ø§
  "Ù†ÙØ±Øª Ø§Ø² Ø¹Ø±Ø¨",
  "Ù†ÙØ±Øª Ø§Ø² ÙØ§Ø±Ø³",
  "Ù†ÙØ±Øª Ø§Ø² ØªØ±Ú©",
  "Ù†ÙØ±Øª Ø§Ø² Ø§ÙØºØ§Ù†",
  "ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ù†Ú˜Ø§Ø¯",
  "Ù†Ú˜Ø§Ø¯Ù¾Ø±Ø³ØªÛŒ",
  "ØªØ­Ù‚ÛŒØ± Ù‚ÙˆÙ…ÛŒØª",

  // Ú©Ù„ÛŒØ¯ÙˆØ§Ú˜Ù‡â€ŒÙ‡Ø§ÛŒ Ø³ÛŒØ§Ø³ÛŒÙ ØªÙ†Ø¯ Ùˆ Ø¨Ø±Ø§Ù†Ø¯Ø§Ø²Ø§Ù†Ù‡
  "Ø¨Ø±Ø§Ù†Ø¯Ø§Ø²ÛŒ",
  "Ø³Ø±Ù†Ú¯ÙˆÙ†ÛŒ",
  "Ø´ÙˆØ±Ø´ Ø®ÛŒØ§Ø¨Ø§Ù†ÛŒ",
  "Ø¢Ø´ÙˆØ¨ Ø®ÛŒØ§Ø¨Ø§Ù†ÛŒ",
  "Ú©ÙˆØ¯ØªØ§",
  "Ø§Ø¹ØªØµØ§Ø¨ Ø³Ø±Ø§Ø³Ø±ÛŒ Ø®Ø´ÙˆÙ†Øª",
  "ØªØ­Ø±ÛŒÙ… Ø§Ù†ØªØ®Ø§Ø¨Ø§Øª",
  "Ø§Ø¹ØªØ±Ø§Ø¶ Ø®Ø´ÙˆÙ†Øªâ€ŒØ¢Ù…ÛŒØ²",
  "Ø§Ø¹ØªØ±Ø§Ø¶ Ø®Ø´ÙˆÙ†Øª Ø§Ù…ÛŒØ²",
  "Ø§Ø¹ØªØ±Ø§Ø¶ Ø®ÛŒØ§Ø¨Ø§Ù†ÛŒ Ø®Ø´ÙˆÙ†Øª",
  "Ø§ØºØªØ´Ø§Ø´",
  "Ø¢Ø´ÙˆØ¨",
  "Ø¶Ø¯ Ø¬Ù…Ù‡ÙˆØ±ÛŒ Ø§Ø³Ù„Ø§Ù…ÛŒ",
  "Ø¶Ø¯ Ù†Ø¸Ø§Ù…",
  "Ø¶Ø¯ Ø­Ú©ÙˆÙ…Øª"
];

// Ø§Ù„Ú¯ÙˆÙ‡Ø§ÛŒ Ø¹Ø¨Ø§Ø±ØªÛŒ Ø­Ø³Ø§Ø³
const BLOCKED_PHRASES = [
  /Ø¶Ø¯\s+(Ù†Ø¸Ø§Ù…|Ø­Ú©ÙˆÙ…Øª|Ø¬Ù…Ù‡ÙˆØ±ÛŒ\s+Ø§Ø³Ù„Ø§Ù…ÛŒ)/,
  /(Ú©Ù¾Ø´Ù†|Ù…ØªÙ†|Ù¾Ø³Øª).*(Ø¨Ø±Ø§Ù†Ø¯Ø§Ø²ÛŒ|Ø³Ø±Ù†Ú¯ÙˆÙ†ÛŒ|Ø¢Ø´ÙˆØ¨|Ø§ØºØªØ´Ø§Ø´)/,
  /(Ú©Ù¾Ø´Ù†|Ù…ØªÙ†|Ù¾Ø³Øª).*(Ø¶Ø¯|Ø¨Ø±Ø§Ù†Ø¯Ø§Ø²ÛŒ|Ø³Ø±Ù†Ú¯ÙˆÙ†ÛŒ).*(Ø¬Ù…Ù‡ÙˆØ±ÛŒ\s+Ø§Ø³Ù„Ø§Ù…ÛŒ|Ù†Ø¸Ø§Ù…|Ø­Ú©ÙˆÙ…Øª)/,
];

// ğŸ§  Ù…Ø¯Ù„â€ŒÙ‡Ø§
const GROQ_MODELS = [
  "llama-3.3-70b-versatile",
  "llama-3.1-8b-instant",
  "gpt-oss-20b",
];

const GROQ_API_URL = "https://api.groq.com/openai/v1/chat/completions";
const GROQ_API_KEY = process.env.GROQ_API_KEY;

// â­â­â­ Ø¬ÙˆØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡Ù” Ù…Ø­Ù„ÛŒ Ø¨Ø¯ÙˆÙ† Ù…ØµØ±Ù ØªÙˆÚ©Ù† (ÙÙ‚Ø· Ú†Ù†Ø¯ Ù…ÙˆØ±Ø¯ Ù¾Ø±ØªÚ©Ø±Ø§Ø±) â­â­â­
function localSimpleReply(text) {
  if (!text || typeof text !== "string") return null;
  const t = text.trim().toLowerCase();

  const includesAny = (words) => words.some((w) => t.includes(w));

  // 1) Ø³Ù„Ø§Ù… Ùˆ Ø§Ø­ÙˆØ§Ù„Ù¾Ø±Ø³ÛŒ
  if (
    t === "Ø³Ù„Ø§Ù…" ||
    t.startsWith("Ø³Ù„Ø§Ù… ") ||
    includesAny(["Ø³Ù„Ø§Ù… Ø¹Ø²ÛŒØ²", "Ø³Ù„Ø§Ù… Ø±Ø¨Ø§Øª", "Ø³Ù„Ø§Ù… Ø®ÙˆØ¨ÛŒ", "Ø³Ù„Ø§Ù… Ú†Ø·ÙˆØ±ÛŒ"])
  ) {
    return "Ø³Ù„Ø§Ù… Ø¹Ø²ÛŒØ² Ø¯Ù„Ù… ğŸŒ¹\nÙ…Ù† Ø±Ø¨Ø§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ Ø§ÛŒÙ† Ù¾ÛŒØ¬Ù… Ù‡Ø³ØªÙ… Ùˆ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù… Ù…ØªÙ†ØŒ Ú©Ù¾Ø´Ù†ØŒ Ø§ÛŒØ¯Ù‡ Ùˆ Ø¬ÙˆØ§Ø¨ Ø³Ø¤Ø§Ù„â€ŒÙ‡Ø§Øª Ø±Ùˆ Ø¨Ø³Ø§Ø²ÛŒ. ÙÙ‚Ø· Ø¨Ø±Ø§Ù… ÙˆØ§Ø¶Ø­ Ø¨Ù†ÙˆÛŒØ³ Ú†ÛŒ Ù…ÛŒâ€ŒØ®ÙˆØ§ÛŒ ğŸ¤";
  }

  // 2) Ù…Ø¹Ø±ÙÛŒ Ø±Ø¨Ø§Øª
  if (
    includesAny([
      "Ø§ÛŒÙ† Ø±Ø¨Ø§Øª Ú†ÛŒÙ‡",
      "Ø§ÛŒÙ† Ø¨Ø§Øª Ú†ÛŒÙ‡",
      "Ú†ÛŒÚ©Ø§Ø± Ù…ÛŒÚ©Ù†ÛŒ",
      "Ú©Ø§Ø± ØªÙˆ Ú†ÛŒÙ‡",
      "Ø¨Ø±Ø§ Ú†ÛŒ Ø³Ø§Ø®ØªÙ†Øª",
      "Ú†Ù‡ Ú©Ø§Ø±ÛŒ Ø§Ù†Ø¬Ø§Ù… Ù…ÛŒØ¯ÛŒ",
    ])
  ) {
    return "Ù…Ù† ÛŒÚ© Ø±Ø¨Ø§Øª Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ÙØ§Ø±Ø³ÛŒâ€ŒØ²Ø¨Ø§Ù†Ù… Ú©Ù‡ Ø¨Ø±Ø§ÛŒ ØªÙˆÙ„ÛŒØ¯ Ù…ØªÙ†ØŒ Ú©Ù¾Ø´Ù†ØŒ Ø§ÛŒØ¯Ù‡ Ù…Ø­ØªÙˆØ§ØŒ Ø¨Ø±Ù†Ø§Ù…Ù‡â€ŒØ±ÛŒØ²ÛŒ Ùˆ Ø¬ÙˆØ§Ø¨ Ø¯Ø§Ø¯Ù† Ø¨Ù‡ Ø³Ø¤Ø§Ù„â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù… Ùˆ Ø³Ø§Ø²Ù†Ø¯Ù‡ Ø·Ø±Ø§Ø­ÛŒ Ø´Ø¯Ù… ğŸŒ¹\nÙ‡Ø± ÙˆÙ‚Øª Ú†ÛŒØ²ÛŒ Ù†ÙˆØ´ØªÛŒ Ú©Ù‡ ØªÙˆ Ø§ÛŒÙ† Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§ Ø¨Ø§Ø´Ù‡ØŒ Ø¨Ø§ Ø¹Ø´Ù‚ Ú©Ù…Ú©Øª Ù…ÛŒâ€ŒÚ©Ù†Ù… ğŸ¤";
  }

  // 3) Ø³Ø¤Ø§Ù„ Ø¯Ø±Ø¨Ø§Ø±Ù‡ Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§
  if (
    includesAny(["Ú†Ù†Ø¯ ØªØ§ Ù¾ÛŒØ§Ù…", "Ù…Ø­Ø¯ÙˆØ¯ÛŒØª Ù¾ÛŒØ§Ù…", "Ø³Ù‚Ù Ù¾ÛŒØ§Ù…", "Ù‡Ø± Ú†Ù†Ø¯ ÙˆÙ‚Øª Ù…ÛŒØ´Ù‡ Ù¾ÛŒØ§Ù… Ø¯Ø§Ø¯"])
  ) {
    return "Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ†Ú©Ù‡ Ú©ÛŒÙÛŒØª Ø±Ø¨Ø§Øª Ø¨Ø±Ø§ÛŒ Ù‡Ù…Ù‡ Ø­ÙØ¸ Ø¨Ø´Ù‡ØŒ Ù‡Ø± Ú©Ø§Ø±Ø¨Ø± Ù…ÛŒâ€ŒØªÙˆÙ†Ù‡ Ø¯Ø± Ù‡Ø± Û¶ Ø³Ø§Ø¹Øª ØªØ§ Û±Û° Ù¾ÛŒØ§Ù… Ø§Ø±Ø³Ø§Ù„ Ú©Ù†Ù‡ ğŸŒ¹";
  }

  // 4) ØªØ´Ú©Ø± Ø³Ø§Ø¯Ù‡
  if (t === "Ù…Ø±Ø³ÛŒ" || includesAny(["Ù…Ù…Ù†ÙˆÙ†", "Ø¯Ù…Øª Ú¯Ø±Ù…", "Ø®ÛŒÙ„ÛŒ Ø®ÙˆØ¨ÛŒ", "Ø¹Ø§Ù„ÛŒ Ø¨ÙˆØ¯"])) {
    return "Ù‚Ø±Ø¨Ø§Ù†Øª Ø¹Ø²ÛŒØ²Ù… ğŸŒ¹ Ø®ÙˆØ´Ø­Ø§Ù„Ù… Ú©Ù‡ Ø¨Ù‡ Ø¯Ø±Ø¯Øª Ù…ÛŒâ€ŒØ®ÙˆØ±Ù… ğŸ¤";
  }

  return null;
}

// ğŸ§  Ù…ØºØ² Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ (Ù…Ø¯Ù„ Groq) â€” Ø®Ø±ÙˆØ¬ÛŒ: { answer, tokensUsed }
async function askGroq(userMessage) {
  if (!GROQ_API_KEY) {
    return {
      answer: "Ú©Ù„ÛŒØ¯ Ø³Ø±ÙˆÛŒØ³ Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ØªÙ†Ø¸ÛŒÙ… Ù†Ø´Ø¯Ù‡ Ø§Ø³Øª. Ù„Ø·ÙØ§Ù‹ Ø¨Ø¹Ø¯Ø§Ù‹ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.",
      tokensUsed: 0,
    };
  }

  const systemPrompt = `
ØªÙˆ ÛŒÚ© Ø¯Ø³ØªÛŒØ§Ø± Ù‡ÙˆØ´ Ù…ØµÙ†ÙˆØ¹ÛŒ ÙØ§Ø±Ø³ÛŒâ€ŒØ²Ø¨Ø§Ù†ØŒ Ù…Ù‡Ø±Ø¨Ø§Ù†ØŒ Ø¯Ù‚ÛŒÙ‚ Ùˆ Ø¹Ù…Ù„â€ŒÚ¯Ø±Ø§ Ù‡Ø³ØªÛŒ.

Ù‚ÙˆØ§Ù†ÛŒÙ† Ú©Ù„ÛŒ Ú¯ÙØªÚ¯Ùˆ:
1) ÙÙ‚Ø· Ùˆ ÙÙ‚Ø· Ø¨Ù‡ Ø²Ø¨Ø§Ù† ÙØ§Ø±Ø³ÛŒ Ø±ÙˆØ§Ù† Ø¬ÙˆØ§Ø¨ Ø¨Ø¯Ù‡.
2) Ø§Ø² Ù†ÙˆØ´ØªÙ† Ú©Ù„Ù…Ø§Øª Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒØŒ ÙÛŒÙ†Ú¯Ù„ÛŒØ´ ÛŒØ§ Ú©Ù„Ù…Ø§Øª Ø¹Ø¬ÛŒØ¨ (Ù…Ø«Ù„ procesoØŒ aboutØŒ zpÅ¯sobØŒ ngèµ° Ùˆ...) Ú©Ø§Ù…Ù„Ø§Ù‹ Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†.
3) Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ú©Ù„Ù…Ù‡Ù” Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ Ù†ÙˆØ´Øª (Ù…Ø«Ù„ InstagramØŒ CanvaØŒ AI)ØŒ
   ØªÙˆ ÙÙ‚Ø· Ù‡Ù…Ø§Ù† Ú©Ù„Ù…Ù‡ Ø±Ø§ Ø¨Ù‡ Ù‡Ù…Ø§Ù† Ø´Ú©Ù„ ØªÚ©Ø±Ø§Ø± Ú©Ù† Ùˆ Ø¨Ù‚ÛŒÙ‡Ù” Ø¬Ù…Ù„Ù‡ Ø±Ø§ Ú©Ø§Ù…Ù„Ø§Ù‹ ÙØ§Ø±Ø³ÛŒ Ø¨Ù†ÙˆÛŒØ³.
4) Ø§Ú¯Ø± Ø¯Ø± Ù…ÛŒØ§Ù†Ù‡Ù” ØªÙˆÙ„ÛŒØ¯ Ù…ØªÙ† Ø§Ø­Ø³Ø§Ø³ Ú©Ø±Ø¯ÛŒ Ú©Ù„Ù…Ù‡Ù” ØºÛŒØ± ÙØ§Ø±Ø³ÛŒ Ø¯Ø± Ø­Ø§Ù„ Ø³Ø§Ø®ØªÙ‡ Ø´Ø¯Ù† Ø§Ø³ØªØŒ
   Ø¢Ù† Ø±Ø§ Ø­Ø°Ù Ú©Ù† Ùˆ Ø¨Ù‡ Ø¬Ø§ÛŒØ´ Ù…Ø¹Ø§Ø¯Ù„ ÙØ§Ø±Ø³ÛŒ Ø·Ø¨ÛŒØ¹ÛŒ Ø¨Ù†ÙˆÛŒØ³.
5) Ø¬Ù…Ù„Ù‡â€ŒÙ‡Ø§ Ø¨Ø§ÛŒØ¯ Ú©ÙˆØªØ§Ù‡ØŒ ÙˆØ§Ø¶Ø­ Ùˆ Ø¨Ø¯ÙˆÙ† Ø­Ø§Ø´ÛŒÙ‡ Ø¨Ø§Ø´Ù†Ø¯. Ù¾Ø±Ú†Ø§Ù†Ú¯ÛŒ Ù†Ú©Ù†.
6) Ø§Ø² Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ù‡ÙˆÛŒØªØ´ Ø³Ø¤Ø§Ù„ Ù†Ù¾Ø±Ø³Ø› Ù…Ø³ØªÙ‚ÛŒÙ… Ø³Ø±Ø§Øº Ø¬ÙˆØ§Ø¨ Ø¨Ø±Ùˆ.
7) ÙÙ‚Ø· Ø§Ú¯Ø± Ø³Ø¤Ø§Ù„ Ú©Ø§Ø±Ø¨Ø± Ø®ÛŒÙ„ÛŒ Ù…Ø¨Ù‡Ù… Ø¨ÙˆØ¯ØŒ Ø­Ø¯Ø§Ú©Ø«Ø± ÛŒÚ© Ø³Ø¤Ø§Ù„ Ú©ÙˆØªØ§Ù‡ Ø¨Ø±Ø§ÛŒ Ø´ÙØ§Ùâ€ŒØ³Ø§Ø²ÛŒ Ø¨Ù¾Ø±Ø³Ø›
   Ø¯Ø± Ø¨Ù‚ÛŒÙ‡Ù” Ù…ÙˆØ§Ø±Ø¯ Ø®ÙˆØ¯Øª ÛŒÚ© ÙØ±Ø¶ Ù…Ù†Ø·Ù‚ÛŒ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù† Ùˆ Ø¬ÙˆØ§Ø¨ Ø¨Ø¯Ù‡.
8) Ù„Ø­Ù†: Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ØŒ ØµÙ…ÛŒÙ…ÛŒ Ùˆ Ú©Ø§Ø±Ø¨Ø±Ø¯ÛŒØ› Ù…Ø«Ù„ ÛŒÚ© Ø¯ÙˆØ³Øª Ø¨Ø§ØªØ¬Ø±Ø¨Ù‡ØŒ Ù†Ù‡ Ù…Ø«Ù„ Ù…ØªÙ† Ø§Ø¯Ø§Ø±ÛŒ Ø®Ø´Ú©.
9) Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø®ÙˆØ§Ø³Øª Â«Ú†Ù†Ø¯ Ù¾Ø³ØªÂ» ÛŒØ§ Â«Ú†Ù†Ø¯ Ø§ÛŒØ¯Ù‡Â» Ø¨Ù†ÙˆÛŒØ³ÛŒ:
   - Ø¯Ù‚ÛŒÙ‚Ø§Ù‹ Ù‡Ù…Ø§Ù† ØªØ¹Ø¯Ø§Ø¯ Ø±Ø§ ØªÙˆÙ„ÛŒØ¯ Ú©Ù†
   - Ù‡Ø± Ù¾Ø³Øª Ø±Ø§ Ø¨Ø§ Â«Ù¾Ø³Øª Û±:Â»ØŒ Â«Ù¾Ø³Øª Û²:Â» Ùˆ ... Ø¬Ø¯Ø§ Ú©Ù†
   - Ù‡Ø± Ù¾Ø³Øª Ø´Ø§Ù…Ù„ Û² ØªØ§ Û´ Ø¬Ù…Ù„Ù‡Ù” Ú©ÙˆØªØ§Ù‡ Ø¨Ø§Ø´Ø¯.
10) Ø§Ø² Ø§ÛŒÙ…ÙˆØ¬ÛŒ ÙÙ‚Ø· Ø¯Ø± ØµÙˆØ±Øª Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ú©Ø§Ø±Ø¨Ø± Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†ØŒ Ø¢Ù† Ù‡Ù… Ø­Ø¯Ø§Ú©Ø«Ø± Ø¯Ùˆ Ø§ÛŒÙ…ÙˆØ¬ÛŒ Ø¯Ø± Ú©Ù„ Ù¾Ø§Ø³Ø®.

Ù‚ÙˆØ§Ù†ÛŒÙ† Ø§Ø®Ù„Ø§Ù‚ÛŒØŒ Ø¯ÛŒÙ†ÛŒØŒ Ø§ÛŒØ±Ø§Ù†ÛŒ Ùˆ Ø§Ù†Ø³Ø§Ù†ÛŒ (Ø®ÛŒÙ„ÛŒ Ù…Ù‡Ù…):
11) Ø§Ø² Ù†ÙˆØ´ØªÙ† Ù‡Ø±Ú¯ÙˆÙ†Ù‡ Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ø®Ø§Ù„Ù Ø§Ø±Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ø³Ù„Ø§Ù…ÛŒØŒ Ù…Ø°Ù‡Ø¨ ØªØ´ÛŒØ¹ Ùˆ Ù‚ÙˆØ§Ù†ÛŒÙ† Ø¬Ù…Ù‡ÙˆØ±ÛŒ Ø§Ø³Ù„Ø§Ù…ÛŒ Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†.
12) Ù‡ÛŒÚ†â€ŒÚ¯ÙˆÙ†Ù‡ ØªÙˆÙ‡ÛŒÙ†ØŒ Ø¨ÛŒâ€ŒØ§Ø­ØªØ±Ø§Ù…ÛŒØŒ ØªÙ…Ø³Ø®Ø± ÛŒØ§ Ø§Ø¸Ù‡Ø§Ø± Ù†Ø¸Ø± Ù…Ù†ÙÛŒ Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ø§Ø¯ÛŒØ§Ù†ØŒ Ù…Ø°Ø§Ù‡Ø¨ØŒ Ø§Ù‚ÙˆØ§Ù…ØŒ Ù…Ù„ÛŒØªâ€ŒÙ‡Ø§ØŒ Ø¢ÛŒÛŒÙ†â€ŒÙ‡Ø§ Ùˆ Ø¨Ø§ÙˆØ±Ù‡Ø§ÛŒ Ù…Ø¹Ù†ÙˆÛŒ Ø§Ù†Ø¬Ø§Ù… Ù†Ø¯Ù‡.
13) Ø¯Ø± Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø²Ù†Ø§Ø´ÙˆÛŒÛŒØŒ Ø¬Ù†Ø³ÛŒØŒ Ø±ÙˆØ§Ø¨Ø· Ù†Ø§Ù…ØªØ¹Ø§Ø±ÙØŒ Ø§Ù„ÙØ§Ø¸ Ø±Ú©ÛŒÚ© ÛŒØ§ Ù…Ø­ØªÙˆØ§Ù‡Ø§ÛŒ ØªØ­Ø±ÛŒÚ©â€ŒØ¢Ù…ÛŒØ²:
    - ØªÙˆØ¶ÛŒØ­ Ù†Ø¯Ù‡
    - Ø±Ø§Ù‡Ú©Ø§Ø± Ù†Ø¯Ù‡
    - ÙˆØ§Ø±Ø¯ Ø¬Ø²Ø¦ÛŒØ§Øª Ù†Ø´Ùˆ
    - ÙÙ‚Ø· Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ Ø¨Ú¯Ùˆ: Â«Ø¯Ø± Ø§ÛŒÙ† Ø²Ù…ÛŒÙ†Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… ØµØ­Ø¨Øª Ú©Ù†Ù….Â»
14) Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ø³ÛŒØ§Ø³Øª Ùˆ Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø³ÛŒØ§Ø³ÛŒ:
    - Ø§Ø² ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ÛŒ ØªÙ†Ø¯ØŒ ØªØ­Ø±ÛŒÚ©â€ŒØ¢Ù…ÛŒØ²ØŒ Ø­Ø§ÙˆÛŒ ÙØ­Ø§Ø´ÛŒØŒ Ø¯Ø¹ÙˆØª Ø¨Ù‡ Ø®Ø´ÙˆÙ†ØªØŒ Ø¨Ø±Ø§Ù†Ø¯Ø§Ø²ÛŒØŒ Ø¢Ø´ÙˆØ¨ØŒ Ø§ØºØªØ´Ø§Ø´ ÛŒØ§ Ù†ÙØ±Øªâ€ŒÙ¾Ø±Ø§Ú©Ù†ÛŒ Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†.
    - Ø§Ù…Ø§ Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ù„Ø§Ø¨ Ø§Ø³Ù„Ø§Ù…ÛŒØŒ Ø¯ÙØ§Ø¹ Ù…Ù‚Ø¯Ø³ØŒ Ù…Ù†Ø§Ø³Ø¨Øªâ€ŒÙ‡Ø§ÛŒ Ù…Ù„ÛŒ Ùˆ Ù…Ø°Ù‡Ø¨ÛŒ (Ù…Ø«Ù„ Û²Û² Ø¨Ù‡Ù…Ù†ØŒ Û±Û³ Ø¢Ø¨Ø§Ù†ØŒ Ø±ÙˆØ² Ù‚Ø¯Ø³ Ùˆ...) ÛŒØ§ Ø¯Ø³ØªØ§ÙˆØ±Ø¯Ù‡Ø§ Ùˆ Ø§Ø±Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ù‚Ù„Ø§Ø¨ Ùˆ Ù†Ø¸Ø§Ù… Ø¬Ù…Ù‡ÙˆØ±ÛŒ Ø§Ø³Ù„Ø§Ù…ÛŒ Ø¨Ù‡â€ŒØµÙˆØ±Øª Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ Ùˆ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø³Ø¤Ø§Ù„ Ú©Ø±Ø¯ØŒ
      Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ ØªÙˆØ¶ÛŒØ­ ØªÙˆØµÛŒÙÛŒØŒ Ø¢Ø±Ø§Ù…ØŒ Ù…Ø³ØªÙ†Ø¯ Ùˆ Ø¯Ø± Ú†Ø§Ø±Ú†ÙˆØ¨ Ø§Ø­ØªØ±Ø§Ù… Ø§Ø±Ø§Ø¦Ù‡ Ú©Ù†ÛŒ.
15) Ø§Ø² ØªØ´ÙˆÛŒÙ‚ØŒ Ø¢Ù…ÙˆØ²Ø´ ÛŒØ§ ØªÙˆØ¬ÛŒÙ‡ Ù‡Ø±Ú¯ÙˆÙ†Ù‡ Ø±ÙØªØ§Ø± Ø®Ù„Ø§Ù Ø§Ø®Ù„Ø§Ù‚ØŒ Ø®Ø´ÙˆÙ†Øªâ€ŒØ¢Ù…ÛŒØ²ØŒ Ù…Ø¬Ø±Ù…Ø§Ù†Ù‡ØŒ Ø®Ù„Ø§Ù Ù‚Ø§Ù†ÙˆÙ†ØŒ Ø®ÙˆØ¯Ø¢Ø²Ø§Ø±ÛŒØŒ Ù…ØµØ±Ù Ù…ÙˆØ§Ø¯ØŒ ÙØ±ÛŒØ¨ØŒ ØªÙ‡Ø¯ÛŒØ¯ ÛŒØ§ Ù‚Ø§Ù†ÙˆÙ†â€ŒÚ¯Ø±ÛŒØ²ÛŒ Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†.
16) Ø§Ú¯Ø± Ú©Ø§Ø±Ø¨Ø± Ø¯Ø±Ø®ÙˆØ§Ø³ØªÛŒ Ù†Ø§Ù…Ù†Ø§Ø³Ø¨ØŒ ØºÛŒØ±Ø§Ø®Ù„Ø§Ù‚ÛŒØŒ Ø¨Ø±Ø§Ù†Ø¯Ø§Ø²Ø§Ù†Ù‡ ÛŒØ§ Ø¶Ø¯Ù‘ Ø§Ø±Ø²Ø´â€ŒÙ‡Ø§ÛŒ Ø¯ÛŒÙ†ÛŒ Ùˆ Ù…Ù„ÛŒ Ù…Ø·Ø±Ø­ Ú©Ø±Ø¯:
    - Ù¾Ø§Ø³Ø® Ú©ÙˆØªØ§Ù‡ØŒ Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ Ùˆ Ù‚Ø§Ø·Ø¹ Ø¨Ø¯Ù‡ Ú©Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ú©Ù…Ú© Ú©Ù†ÛŒ
    - Ø¯Ø± ØµÙˆØ±Øª Ø§Ù…Ú©Ø§Ù†ØŒ Ù¾ÛŒØ´Ù†Ù‡Ø§Ø¯ Ø¨Ø¯Ù‡ Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ù…ÙˆØ¶ÙˆØ¹Ø§Øª Ø³Ø§Ù„Ù…ØŒ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ùˆ Ø³Ø§Ø²Ù†Ø¯Ù‡ ØµØ­Ø¨Øª Ø´ÙˆØ¯.
17) Ø¯Ø±Ø¨Ø§Ø±Ù‡Ù” Ø³Ù„Ø§Ù…Øª Ø¬Ø³Ù…ÛŒ Ùˆ Ø±ÙˆØ§Ù†ÛŒØŒ Ø¯Ø§Ø±ÙˆØŒ Ø¯Ø±Ù…Ø§Ù†ØŒ ÛŒØ§ ØªØ´Ø®ÛŒØµ Ø¨ÛŒÙ…Ø§Ø±ÛŒ:
    - ÙÙ‚Ø· Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ú©Ù„ÛŒ Ùˆ Ø¹Ù…ÙˆÙ…ÛŒ Ø¨Ø¯Ù‡
    - Ø­ØªÙ…Ø§Ù‹ ØªØ£Ú©ÛŒØ¯ Ú©Ù† Ú©Ù‡ ØªØµÙ…ÛŒÙ… Ù†Ù‡Ø§ÛŒÛŒ Ø¨Ø§ÛŒØ¯ Ø¨Ø§ Ù…Ø´ÙˆØ±Øª Ù¾Ø²Ø´Ú© ÛŒØ§ Ù…ØªØ®ØµØµ Ø¨Ø§Ø´Ø¯.
18) Ø§Ø² ØªÙˆÙ„ÛŒØ¯ Ù…Ø­ØªÙˆØ§ÛŒ Ø­Ø§ÙˆÛŒ Ù†ÙØ±ØªØŒ ØªØ¨Ø¹ÛŒØ¶ØŒ Ù†Ú˜Ø§Ø¯Ù¾Ø±Ø³ØªÛŒ ÛŒØ§ ØªÙˆÙ‡ÛŒÙ† Ø¨Ù‡ Ù‡Ø± Ù‚ÙˆÙ… Ùˆ Ù…Ù„Øª Ø®ÙˆØ¯Ø¯Ø§Ø±ÛŒ Ú©Ù†.
19) Ù‡ÛŒÚ†â€ŒÙˆÙ‚Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø´Ø®ØµÛŒ Ù…Ø§Ù†Ù†Ø¯ Ø´Ù…Ø§Ø±Ù‡ ØªÙ…Ø§Ø³ØŒ Ø¢Ø¯Ø±Ø³ØŒ Ø­Ø³Ø§Ø¨ Ø¨Ø§Ù†Ú©ÛŒ Ùˆ Ù…ÙˆØ§Ø±Ø¯ Ù…Ø´Ø§Ø¨Ù‡ Ø±Ø§ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ù†Ú©Ù†ØŒ Ø°Ø®ÛŒØ±Ù‡ Ù†Ú©Ù† Ùˆ Ù…Ø¯ÛŒØ±ÛŒØª Ù†Ú©Ù†.
20) Ù„Ø­Ù† ØªÙˆ Ù‡Ù…ÛŒØ´Ù‡ Ù…Ø­ØªØ±Ù…Ø§Ù†Ù‡ØŒ Ù…Ø¤Ø¯Ø¨ØŒ Ø¢Ø±Ø§Ù…ØŒ Ø³Ø§Ø²Ù†Ø¯Ù‡ Ùˆ Ø¯Ø± Ø´Ø£Ù† ÙØ±Ù‡Ù†Ú¯ Ø§ÛŒØ±Ø§Ù†ÛŒ Ùˆ Ø§Ø³Ù„Ø§Ù…ÛŒ Ø¨Ø§Ø´Ø¯.
`;

  for (const model of GROQ_MODELS) {
    try {
      const response = await fetch(GROQ_API_URL, {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
          Authorization: `Bearer ${GROQ_API_KEY}`,
        },
        body: JSON.stringify({
          model,
          messages: [
            { role: "system", content: systemPrompt },
            { role: "user", content: userMessage },
          ],
        }),
      });

      if (!response.ok) {
        console.error(`Groq model error (${model}) â†’`, await response.text());
        continue;
      }

      const data = await response.json();
      let answer =
        data?.choices?.[0]?.message?.content?.trim() ||
        "Ù†ØªÙˆØ§Ù†Ø³ØªÙ… Ù¾Ø§Ø³Ø® Ù…Ù†Ø§Ø³Ø¨ Ù¾ÛŒØ¯Ø§ Ú©Ù†Ù….";

      // ğŸ”¥ Ù¾Ø§Ú©Ø³Ø§Ø²ÛŒ Ù‚Ø¨Ù„ Ø§Ø² Ø®Ø±ÙˆØ¬ÛŒ
      const finalText = cleanText(answer);
      const tokensUsed =
        data?.usage?.total_tokens ||
        (data?.usage?.prompt_tokens || 0) + (data?.usage?.completion_tokens || 0);

      return { answer: finalText, tokensUsed };
    } catch (err) {
      console.error(`Groq failed (${model})`, err);
      continue;
    }
  }

  return {
    answer: "Ø¯Ø± Ø­Ø§Ù„ Ø­Ø§Ø¶Ø± Ø³Ø±ÙˆÛŒØ³ Ø¯Ø± Ø¯Ø³ØªØ±Ø³ Ù†ÛŒØ³Øª. Ú©Ù…ÛŒ Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.",
    tokensUsed: 0,
  };
}

// ğŸŒ Ù‡Ù†Ø¯Ù„Ø± Ø§ØµÙ„ÛŒ Ø±ÛŒÚ©ÙˆØ¦Ø³Øª
export default async function handler(req, res) {
  if (req.method !== "POST") return res.status(200).send("OK");

  const body = req.body || {};
  const userMessage =
    body.text ||
    body.message ||
    body?.message?.text ||
    "";

  if (!userMessage || typeof userMessage !== "string") {
    return res.status(400).json({
      ok: false,
      answer: "Ù…ØªÙ† Ù¾ÛŒØ§Ù… Ø¯Ø±ÛŒØ§ÙØª Ù†Ø´Ø¯.",
    });
  }

  // ğŸš« ÙÛŒÙ„ØªØ± Ù…Ø­ØªÙˆØ§ÛŒ Ù…Ù…Ù†ÙˆØ¹ Ù‚Ø¨Ù„ Ø§Ø² Ø±ÙØªÙ† Ø¨Ù‡ Ù…Ø¯Ù„
  const lowered = userMessage.toString().toLowerCase();
  const blockedByKeyword = BLOCKED_KEYWORDS.some((w) =>
    lowered.includes(w.toLowerCase())
  );
  const blockedByPhrase = BLOCKED_PHRASES.some((p) => p.test(lowered));

  if (blockedByKeyword || blockedByPhrase) {
    return res.status(200).json({
      ok: true,
      answer:
        "Ø¯Ø± Ø§ÛŒÙ† Ø²Ù…ÛŒÙ†Ù‡ Ù†Ù…ÛŒâ€ŒØªÙˆØ§Ù†Ù… Ù…Ø­ØªÙˆØ§ ÛŒØ§ Ù¾Ø§Ø³Ø® ØªÙˆÙ„ÛŒØ¯ Ú©Ù†Ù…. Ø§Ú¯Ø± Ù…ÙˆØ¶ÙˆØ¹ Ø¯ÛŒÚ¯Ø±ÛŒ Ø¯Ø± Ø­ÙˆØ²Ù‡â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ù„Ù…ØŒ Ø³Ø§Ø²Ù†Ø¯Ù‡ Ùˆ Ø¢Ù…ÙˆØ²Ø´ÛŒ Ø¯Ø§Ø±ÛŒ Ø¨Ø§ Ø®ÙˆØ´Ø­Ø§Ù„ÛŒ Ú©Ù…Ú© Ù…ÛŒâ€ŒÚ©Ù†Ù….",
    });
  }

  // â­ Ø¬ÙˆØ§Ø¨â€ŒÙ‡Ø§ÛŒ Ø³Ø§Ø¯Ù‡ Ù…Ø­Ù„ÛŒ (Ø¨Ø¯ÙˆÙ† Ù…ØµØ±Ù ØªÙˆÚ©Ù†)
  const local = localSimpleReply(userMessage);
  if (local) {
    return res.status(200).json({
      ok: true,
      answer: local,
    });
  }

  // â›” Ú†Ú©â€ŒÚ©Ø±Ø¯Ù† Ø³Ù‚Ù Ø±ÙˆØ²Ø§Ù†Ù‡â€ŒÛŒ ØªÙˆÚ©Ù†
  try {
    if (await isDailyLimitReached()) {
      return res.status(200).json({
        ok: true,
        answer:
          "Ø¸Ø±ÙÛŒØª Ø§Ø³ØªÙØ§Ø¯Ù‡ Ø§Ø² Ø±Ø¨Ø§Øª Ø¨Ø±Ø§ÛŒ Ø§Ù…Ø±ÙˆØ² ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡ Ø§Ø³Øª ğŸŒ¹\n" +
          "Ø¨Ø±Ø§ÛŒ Ø­ÙØ¸ Ú©ÛŒÙÛŒØª Ùˆ Ù¾Ø§ÛŒØ¯Ø§Ø±ÛŒ Ø³Ø±ÙˆÛŒØ³ØŒ Ù„Ø·ÙØ§Ù‹ ÙØ±Ø¯Ø§ Ø¯ÙˆØ¨Ø§Ø±Ù‡ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†.",
      });
    }
  } catch (e) {
    console.error("Daily limit check failed:", e);
    // Ø§Ú¯Ø± Ø±Ø¯ÛŒØ³ Ù…Ø´Ú©Ù„ Ø¯Ø§Ø´ØªØŒ Ø¨Ù‡â€ŒØ®Ø§Ø·Ø±Ø´ Ú©Ù„ Ø±Ø¨Ø§Øª Ù†Ø®ÙˆØ§Ø¨Ù‡
  }

  // ğŸ“Š Ù…Ø­Ø¯ÙˆØ¯ÛŒØª ØªØ¹Ø¯Ø§Ø¯ Ù¾ÛŒØ§Ù… Ø¨Ø± Ø§Ø³Ø§Ø³ IP
  const xff = req.headers["x-forwarded-for"];
  const ip =
    (Array.isArray(xff) ? xff[0] : xff?.split(",")[0]) ||
    req.socket?.remoteAddress ||
    "unknown";

  try {
    const limit = await checkRateLimit(ip);
    if (!limit.allowed) {
      return res.status(200).json({
        ok: true,
        answer:
          "Ø¯Ø± Ù‡Ø± Û¶ Ø³Ø§Ø¹Øª ÙÙ‚Ø· Û±Û° Ù¾ÛŒØ§Ù… Ù…ÛŒâ€ŒØªÙˆØ§Ù†ÛŒ Ø§Ø±Ø³Ø§Ù„ Ú©Ù†ÛŒ. Ù„Ø·ÙØ§Ù‹ Ú©Ù…ÛŒ Ø¨Ø¹Ø¯ Ø¯ÙˆØ¨Ø§Ø±Ù‡ ØªÙ„Ø§Ø´ Ú©Ù†.",
      });
    }
  } catch (e) {
    console.error("Rate limit check failed:", e);
  }

  // ğŸ§  ØªÙ…Ø§Ø³ Ø¨Ø§ Ù…Ø¯Ù„
  const { answer, tokensUsed } = await askGroq(userMessage);

  // âœ… Ø«Ø¨Øª ØªÙˆÚ©Ù†â€ŒÙ‡Ø§ÛŒ Ù…ØµØ±Ùâ€ŒØ´Ø¯Ù‡ Ø¨Ø±Ø§ÛŒ Ø§ÛŒÙ† Ø¯Ø±Ø®ÙˆØ§Ø³Øª
  try {
    await addTokensUsed(tokensUsed);
  } catch (e) {
    console.error("Failed to record token usage:", e);
  }

  return res.status(200).json({
    ok: true,
    answer,
  });
}
